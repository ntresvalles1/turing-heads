function c(e){return e.pathname.startsWith("/scope:")}function f(e){return c(e)?e.pathname.split("/")[1].split(":")[1]:null}function R(e,t){let r=new URL(e);if(c(r))if(t){const n=r.pathname.split("/");n[1]=`scope:${t}`,r.pathname=n.join("/")}else r=u(r);else if(t){const n=r.pathname==="/"?"":r.pathname;r.pathname=`/scope:${t}${n}`}return r}function u(e){if(!c(e))return e;const t=new URL(e),r=t.pathname.split("/");return t.pathname="/"+r.slice(2).join("/"),t}const U=25e3;let L=0;function S(){return++L}function h(e,t,r=U){return new Promise((n,i)=>{const a=s=>{s.data.type==="response"&&s.data.requestId===t&&(e.removeEventListener("message",a),clearTimeout(o),n(s.data.response))},o=setTimeout(()=>{i(new Error("Request timed out")),e.removeEventListener("message",a)},r);e.addEventListener("message",a)})}function W(e){const{handleRequest:t=P}=e;self.addEventListener("fetch",r=>{const n=new URL(r.request.url);if(n.pathname.startsWith(self.location.pathname))return;if(!c(n)){let a;try{a=new URL(r.request.referrer)}catch{return}if(!c(a))return}console.debug(`[ServiceWorker] Serving request: ${T(u(n))}`);const i=t(r);i&&r.respondWith(i)})}async function P(e){e.preventDefault();const t=new URL(e.request.url),r=u(t);return y(r.pathname)?m(e):fetch(await g(e.request,{url:t}))}async function m(e){let t=new URL(e.request.url);if(!c(t))try{const s=new URL(e.request.referrer);t=R(t,f(s))}catch{}const{body:r,files:n,contentType:i}=await E(e.request),a={};for(const s of e.request.headers.entries())a[s[0]]=s[1];let o;try{const s={method:"request",args:[{body:r,files:n,url:t.toString(),method:e.request.method,headers:{...a,Host:t.host,"User-agent":self.navigator.userAgent,"Content-type":i}}]},d=f(t);if(d===null)throw new Error(`The URL ${t.toString()} is not scoped. This should not happen.`);console.debug("[ServiceWorker] Forwarding a request to the Worker Thread",{message:s});const l=await w(s,d);o=await h(self,l),delete o.headers["x-frame-options"],console.debug("[ServiceWorker] Response received from the main app",{phpResponse:o})}catch(s){throw console.error(s,{url:t.toString()}),s}return new Response(o.bytes,{headers:o.headers,status:o.httpStatusCode})}async function w(e,t){const r=S();for(const n of await self.clients.matchAll({includeUncontrolled:!0}))n.postMessage({...e,scope:t,requestId:r});return r}function y(e){return q(e)||b(e)}function q(e){return e.endsWith(".php")||e.includes(".php/")}function b(e){return!e.split("/").pop().includes(".")}async function E(e){const t=e.headers.get("content-type");if(e.method!=="POST")return{contentType:t,body:void 0,files:void 0};if(t.toLowerCase().startsWith("multipart/form-data"))try{const n=await e.clone().formData(),i={},a={};for(const o of n.keys()){const s=n.get(o);s instanceof File?a[o]=s:i[o]=s}return{contentType:"application/x-www-form-urlencoded",body:new URLSearchParams(i).toString(),files:a}}catch{}return{contentType:t,body:await e.clone().text(),files:{}}}async function g(e,t){const r=["GET","HEAD"].includes(e.method)||"body"in t?void 0:await e.blob();return new Request(t.url||e.url,{body:r,method:e.method,headers:e.headers,referrer:e.referrer,referrerPolicy:e.referrerPolicy,mode:e.mode==="navigate"?"same-origin":e.mode,credentials:e.credentials,cache:e.cache,redirect:e.redirect,integrity:e.integrity,...t})}function T(e){return e.toString().substring(e.origin.length)}const k=e=>e.startsWith("/wp-content/uploads/")||e.startsWith("/wp-content/plugins/")||e.startsWith("/wp-content/mu-plugins/")||e.startsWith("/wp-content/themes/");self.document||(self.document={});W({handleRequest(e){const t=new URL(e.request.url);let r=f(t);if(!r)try{r=f(new URL(e.request.referrer))}catch{}const n=u(t);if(n.pathname.startsWith("/plugin-proxy"))return;e.preventDefault();async function a(){const{staticAssetsDirectory:o,defaultTheme:s}=await H(r);if((y(n.pathname)||k(n.pathname))&&!n.pathname.startsWith(`/wp-content/themes/${s}`)){const l=await m(e);return l.headers.set("Cross-Origin-Resource-Policy","cross-origin"),l.headers.set("Cross-Origin-Embedder-Policy","credentialless"),l}const d=await D(e.request,o);return fetch(d)}return a()}});const p={};async function D(e,t){const r=new URL(e.url),n=u(r);return!n.pathname.startsWith("/@fs")&&!n.pathname.startsWith("/assets")&&(n.pathname=`/${t}${n.pathname}`),await g(e,{url:n})}async function H(e){if(!p[e]){const t=await w({method:"getWordPressModuleDetails"},e);p[e]=await h(self,t)}return p[e]}
